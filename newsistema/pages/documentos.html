<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Documentos - ONG Novo Amanhã</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
<link href="../css/config-styles.css" rel="stylesheet"/>
<link href="../css/global.css" rel="stylesheet"/>
<link href="../css/navbar.css" rel="stylesheet"/>
<link href="../css/cards.css" rel="stylesheet"/>
<link href="../css/background-pattern.css" rel="stylesheet"/>
<link href="../css/themes.css" rel="stylesheet"/>
<link href="../css/documentos.css" rel="stylesheet"/>
<script src="../js/auth-guard.js" type="module"></script>
<script src="../js/permissoes.js" type="module"></script>
<script src="../js/preferencias.js" type="module"></script>
<script src="../js/preferencia-aplicacao.js" type="module"></script>
</head>
<body><i class="fa fa-bell" id="notificacoes"></i>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow" style="background-color: var(--primary-color);">
<div class="container-fluid">
<a class="navbar-brand" href="#" style="display: flex; align-items: center; gap: 10px;">
<i class="bi bi-box-seam"></i>
<span class="h5 mb-0" data-i18n="platform_name">Beta - Plataforma de Gestão</span>
</a>
<div class="d-flex align-items-center">
<a class="btn btn-outline-light me-3" href="pages/menu.html">
<i class="bi bi-house-door"></i>
                    Início
                </a>
<div class="dropdown">
<div aria-expanded="false" class="user-profile" data-bs-toggle="dropdown" id="userProfileDropdown">
<div class="avatar" id="userAvatar">UT</div>
<div class="user-info">
<span class="user-name" data-i18n="user_name" id="userName">Usuário</span>
<i class="bi bi-chevron-down dropdown-arrow"></i>
</div>
</div>
<ul aria-labelledby="userProfileDropdown" class="dropdown-menu dropdown-menu-end">
<li>
<div class="dropdown-header">
<div class="avatar-small" id="userAvatarSmall">UT</div>
<div class="header-info">
<span class="header-name" data-i18n="user_full_name" id="userNameFull">Usuário</span>
<span class="header-email" data-i18n="user_email" id="userEmail">usuario@email.com</span>
</div>
</div>
</li>
<li><hr class="dropdown-divider"/></li>
<li>
<a class="dropdown-item" href="pages/perfil.html" title="Visualizar e editar seu perfil">
<i class="bi bi-person-circle"></i>
<div class="item-content">
<span class="item-title" data-i18n="profile">Perfil</span>
<span class="item-description" data-i18n="view_edit_profile">Visualizar e editar suas informações</span>
</div>
</a>
</li>
<li>
<a class="dropdown-item" href="pages/configuracoes.html" title="Ajustar configurações do sistema">
<i class="bi bi-gear"></i>
<div class="item-content">
<span class="item-title" data-i18n="settings">Configurações</span>
<span class="item-description" data-i18n="customize_experience">Personalizar sua experiência</span>
</div>
</a>
</li>
<li><hr class="dropdown-divider"/></li>
<li>
<a class="dropdown-item logout-item" href="#" id="btnLogout" title="Sair do sistema">
<i class="bi bi-box-arrow-right"></i>
<div class="item-content">
<span class="item-title" data-i18n="logout">Sair</span>
<span class="item-description" data-i18n="end_session">Encerrar sessão</span>
</div>
</a>
</li>
</ul>
</div>
</div>
</div>
</nav>
<ul class="navbar-nav ms-auto">
<li class="nav-item">
<a class="nav-link" href="pages/menu.html">
<i class="bi bi-house-door-fill"></i> Menu Principal
                        </a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="userProfileLink">
<i class="bi bi-person-circle"></i> Perfil
                        </a>
</li>
<li class="nav-item">
<a class="nav-link" href="#" id="logoutButton">
<i class="bi bi-box-arrow-right"></i> Sair
                        </a>
</li>
</ul>
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner"></div>
</div>
<!-- Elementos decorativos de fundo -->
<div class="bg-pattern"></div>
<div class="top-gradient"></div>
<div class="decoration-circle circle-1"></div>
<div class="decoration-circle circle-2"></div>
<!-- Conteúdo Principal -->
<div class="container py-3 mt-4">
<!-- Barra de Busca -->
<div class="row mb-3">
<div class="col-12">
<div class="search-container">
<div class="search-box">
<i class="bi bi-search search-icon"></i>
<input class="form-control search-input" id="searchInput" placeholder="Buscar documentos por nome, tipo ou conteúdo..." type="text"/>
<div class="search-actions">
<button class="btn btn-link btn-search-clear d-none" id="clearSearch">
<i class="bi bi-x-lg"></i>
</button>
<div class="search-divider"></div>
<button class="btn btn-link btn-search-filter" data-bs-target="#searchFilters" data-bs-toggle="collapse">
<i class="bi bi-sliders2"></i>
</button>
</div>
</div>
<!-- Filtros Rápidos Colapsáveis -->
<div class="collapse" id="searchFilters">
<div class="quick-filters mt-2">
<div class="filter-chips">
<button class="chip" data-type="pdf">
<i class="bi bi-file-pdf"></i> PDFs
                                </button>
<button class="chip" data-type="docx">
<i class="bi bi-file-word"></i> Word
                                </button>
<button class="chip" data-type="xlsx">
<i class="bi bi-file-excel"></i> Excel
                                </button>
<button class="chip" data-type="image">
<i class="bi bi-file-image"></i> Imagens
                                </button>
</div>
<div class="filter-date">
<select class="form-select form-select-sm" id="quickFilterDate">
<option value="all">Qualquer data</option>
<option value="today">Hoje</option>
<option value="week">Esta semana</option>
<option value="month">Este mês</option>
</select>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Seção de Favoritos -->
<div class="row mb-4 favoritos-section d-none">
<div class="col-12">
<div class="section-header">
<h4 class="mb-3">
<i class="bi bi-star-fill text-warning"></i>
                        Favoritos
                    </h4>
</div>
<div class="row" id="favoritosList"></div>
</div>
</div>
<!-- Seção de Pastas -->
<div class="row mb-3">
<div class="col-12">
<div class="section-header d-flex justify-content-between align-items-center mb-2">
<h4>
<i class="bi bi-folder2"></i>
                        Pastas
                    </h4>
<button class="btn btn-primary" onclick="criarPasta()">
<i class="bi bi-folder-plus me-2"></i>
                        Nova Pasta
                    </button>
</div>
<div class="row g-4" id="pastasList"></div>
</div>
</div>
<!-- Seção de Documentos -->
<div class="row">
<!-- Barra Lateral de Filtros -->
<div class="col-md-3">
<div class="filter-sidebar card">
<h5 class="mb-4">Filtros</h5>
<div class="mb-4">
<h6>Tipo de Documento</h6>
<div class="form-check">
<input class="form-check-input" id="filterPdf" type="checkbox" value="pdf"/>
<label class="form-check-label" for="filterPdf">PDF</label>
</div>
<div class="form-check">
<input class="form-check-input" id="filterDocx" type="checkbox" value="docx"/>
<label class="form-check-label" for="filterDocx">Word (DOCX)</label>
</div>
<div class="form-check">
<input class="form-check-input" id="filterXlsx" type="checkbox" value="xlsx"/>
<label class="form-check-label" for="filterXlsx">Excel (XLSX)</label>
</div>
<div class="form-check">
<input class="form-check-input" id="filterImage" type="checkbox" value="image"/>
<label class="form-check-label" for="filterImage">Imagens</label>
</div>
</div>
<div class="mb-4">
<h6>Período</h6>
<select class="form-select" id="filterDate">
<option value="all">Todos</option>
<option value="today">Hoje</option>
<option value="week">Última Semana</option>
<option value="month">Último Mês</option>
<option value="custom">Personalizado</option>
</select>
<div class="mt-2 d-none" id="customDateRange">
<input class="form-control mb-2" id="dateStart" type="date"/>
<input class="form-control" id="dateEnd" type="date"/>
</div>
</div>
<div class="mb-4">
<h6>Tags</h6>
<input class="form-control" id="filterTags" placeholder="Filtrar por tags" type="text"/>
</div>
</div>
</div>
<div class="col-md-9">
<div class="upload-area mb-3" id="dropZone">
<i class="bi bi-cloud-upload document-icon mb-3"></i>
<h4>Arraste e solte arquivos aqui</h4>
<p class="text-muted">ou</p>
<input accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" class="d-none" id="fileInput" multiple="" type="file"/>
<div class="upload-buttons">
<button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
<i class="bi bi-plus-lg me-2"></i>Selecionar Arquivos
        </button>
<button class="btn btn-outline-primary" onclick="document.getElementById('novaPastaModal').showModal()">
<i class="bi bi-folder-plus me-2"></i>Nova Pasta
        </button>
</div>
<p class="mt-2 small text-muted">Formatos suportados: PDF, DOCX, XLS, JPEG, etc.</p>
</div>
<!-- Lista de Documentos -->
<div class="documentos-lista">
<div class="lista-header">
<div class="row align-items-center">
<div class="col-md-6">
<h5 class="mb-0">
<i class="bi bi-file-earmark-text"></i>
                    Documentos Recentes
                </h5>
</div>
<div class="col-md-6 text-md-end">
<div class="btn-group">
<button class="btn btn-outline-secondary btn-sm" onclick="ordenarPor('nome')">
<i class="bi bi-sort-alpha-down"></i>
                        Nome
                    </button>
<button class="btn btn-outline-secondary btn-sm" onclick="ordenarPor('data')">
<i class="bi bi-calendar"></i>
                        Data
                    </button>
</div>
</div>
</div>
</div>
<div class="table-responsive">
<table class="table table-hover align-middle">
<thead>
<tr>
<th style="width: 40px"></th>
<th>Nome</th>
<th>Tipo</th>
<th>Tamanho</th>
<th>Data de Upload</th>
<th>Pasta</th>
<th style="width: 100px">Ações</th>
</tr>
</thead>
<tbody id="documentsList">
<!-- Documentos serão inseridos aqui via JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="modal fade document-preview-modal" id="previewModal" tabindex="-1">
<div class="modal-dialog modal-xl">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Preview do Documento</h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-9">
<div class="bg-light rounded p-3" id="documentPreview" style="min-height: 500px;"></div>
<div class="mt-4">
<h6>Comentários</h6>
<div class="comentarios-container" id="comentariosList">
</div>
<div class="mt-3">
<textarea class="form-control" id="novoComentario" placeholder="Adicione um comentário..." rows="2"></textarea>
<button class="btn btn-purple btn-sm mt-2" onclick="adicionarComentario()">
<i class="bi bi-chat-dots"></i> Comentar
                                    </button>
</div>
</div>
</div>
<div class="col-md-3">
<div class="document-info">
<h6>Informações</h6>
<p class="mb-1"><strong>Nome:</strong> <span id="previewFileName"></span></p>
<p class="mb-1"><strong>Tipo:</strong> <span id="previewFileType"></span></p>
<p class="mb-1"><strong>Tamanho:</strong> <span id="previewFileSize"></span></p>
<p class="mb-3"><strong>Modificado:</strong> <span id="previewLastModified"></span></p>
<h6>Tags</h6>
<div class="mb-3" id="previewTags"></div>
<h6>Histórico de Versões</h6>
<div class="version-history" id="versionHistory"></div>
<h6>Permissões</h6>
<div class="permissions-section">
<div class="mb-2">
<label class="permission-toggle">
<input id="permissionView" type="checkbox"/>
<span class="permission-slider"></span>
</label>
<span class="ms-2">Visualizar</span>
</div>
<div class="mb-2">
<label class="permission-toggle">
<input id="permissionEdit" type="checkbox"/>
<span class="permission-slider"></span>
</label>
<span class="ms-2">Editar</span>
</div>
<div class="mb-2">
<label class="permission-toggle">
<input id="permissionDownload" type="checkbox"/>
<span class="permission-slider"></span>
</label>
<span class="ms-2">Baixar</span>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<div class="btn-group">
<button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" type="button">
                            Exportar como
                        </button>
<ul class="dropdown-menu">
<li><a class="dropdown-item" data-format="pdf" href="#">PDF</a></li>
<li><a class="dropdown-item" data-format="docx" href="#">Word</a></li>
<li><a class="dropdown-item" data-format="xlsx" href="#">Excel</a></li>
</ul>
</div>
<button class="btn btn-outline-secondary" id="printDocument" type="button">
<i class="bi bi-printer"></i> Imprimir
                    </button>
<button class="btn btn-outline-primary" id="shareDocument" type="button">
<i class="bi bi-share"></i> Compartilhar
                    </button>
<button class="btn btn-purple" id="downloadDocument" type="button">
<i class="bi bi-download"></i> Download
                    </button>
</div>
</div>
</div>
</div>
<!-- Modal Nova Pasta -->
<dialog class="modal fade" id="novaPastaModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">Nova Pasta</h5>
<button class="btn-close" data-bs-dismiss="modal" onclick="document.getElementById('novaPastaModal').close()" type="button"></button>
</div>
<div class="modal-body">
<form id="formNovaPasta">
<div class="mb-3">
<label class="form-label" for="nomePasta">Nome da Pasta</label>
<input class="form-control" id="nomePasta" required="" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="descricaoPasta">Descrição (opcional)</label>
<textarea class="form-control" id="descricaoPasta" rows="3"></textarea>
</div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="document.getElementById('novaPastaModal').close()" type="button">
                    Cancelar
                </button>
<button class="btn btn-primary" onclick="criarNovaPasta()" type="button">
                    Criar Pasta
                </button>
</div>
</div>
</div>
</dialog>
<script type="module">
        // Inicialização do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC6E9U_uW3GgbT5YeHZVHtxE-p5jQqvqfw",
            authDomain: "plataforma-ong.firebaseapp.com",
            projectId: "plataforma-ong",
            storageBucket: "plataforma-ong.appspot.com",
            messagingSenderId: "514175198416",
            appId: "1:514175198416:web:c4c0d7c2b5a2a9d2c4c3a3"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Variáveis globais
        let currentUser = null;
        window.documentosCache = [];
        window.pastasCache = [];

        // Monitorar estado da autenticação
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            carregarDados();
        });

        // Configurar todos os event listeners
        function configurarEventListeners() {
            // Listener para upload de arquivos
            document.getElementById('fileInput').addEventListener('change', async (e) => {
                const files = e.target.files;
                if (!files.length) return;

                const pastaId = null; // Documento solto (sem pasta)
                for (const file of files) {
                    await uploadDocumento(file, pastaId);
                }
            });

            // Listener para drag and drop
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const files = e.dataTransfer.files;
                if (!files.length) return;

                const pastaId = null; // Documento solto (sem pasta)
                for (const file of files) {
                    await uploadDocumento(file, pastaId);
                }
            });

            // Filtro de data personalizado
            document.getElementById('filterDate').addEventListener('change', (e) => {
                const customDateRange = document.getElementById('customDateRange');
                customDateRange.classList.toggle('d-none', e.target.value !== 'custom');
            });

            // Busca em tempo real
            document.getElementById('searchInput').addEventListener('input', debounce(realizarBusca, 300));

            // Filtros de tipo de documento
            document.querySelectorAll('.form-check-input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', aplicarFiltros);
            });
        }

        // Função para debounce da busca
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Mostrar/ocultar overlay de carregamento
        function toggleLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Carregar dados iniciais
        async function carregarDados() {
            try {
                toggleLoading(true);

                // Carregar pastas
                const pastasSnapshot = await getDocs(collection(db, 'pastas'));
                window.pastasCache = pastasSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Carregar documentos
                const docsSnapshot = await getDocs(collection(db, 'documentos'));
                window.documentosCache = docsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Renderizar interface
                renderizarPastas();
                renderizarDocumentos();

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Por favor, recarregue a página.');
            } finally {
                toggleLoading(false);
            }
        }

        // Upload de documento
        async function uploadDocumento(file, pastaId = null) {
            try {
                toggleLoading(true);

                // Upload para o Storage
                const storageRef = ref(storage, `documentos/${file.name}`);
                await uploadBytesResumable(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);

                // Salvar metadados no Firestore
                const docRef = await addDoc(collection(db, 'documentos'), {
                    nome: file.name,
                    tipo: file.type,
                    tamanho: file.size,
                    url: downloadURL,
                    pastaId,
                    dataCriacao: new Date().toISOString(),
                    criadorId: currentUser?.uid || 'anonymous'
                });

                // Atualizar cache e interface
                const novoDoc = {
                    id: docRef.id,
                    nome: file.name,
                    tipo: file.type,
                    tamanho: file.size,
                    url: downloadURL,
                    pastaId,
                    dataCriacao: new Date().toISOString()
                };

                documentosCache.push(novoDoc);
                renderizarDocumentos();

            } catch (error) {
                console.error('Erro no upload:', error);
                alert('Erro ao fazer upload do arquivo. Por favor, tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Renderizar lista de pastas
        function renderizarPastas() {
            const pastasContainer = document.getElementById('pastasContainer');
            if (!pastasContainer) return;

            if (pastasCache.length === 0) {
                pastasContainer.innerHTML = '<div class="col-12 text-center text-muted"><p>Nenhuma pasta encontrada</p></div>';
                return;
            }

            pastasContainer.innerHTML = pastasCache.map(pasta => {
                const descricao = pasta.descricao || 'Sem descrição';
                return '<div class="col-md-4 col-lg-3 mb-4">' +
                    '<div class="pasta-card" ' +
                    'ondragover="permitirSoltar(event)" ' +
                    'ondragleave="sairArrastar(event)" ' +
                    `ondrop="soltarDocumento(event, '${pasta.id}')">`+
                    '<div class="card-title">' +
                    '<i class="bi bi-folder2"></i>' +
                    `<h5 class="mb-0">${pasta.nome}</h5>` +
                    '</div>' +
                    `<p class="card-text small text-muted">${descricao}</p>` +
                    '<div class="card-actions">' +
                    `<button class="btn btn-link text-danger" onclick="excluirPasta('${pasta.id}')">` +
                    '<i class="bi bi-trash"></i>' +
                    '</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
            }).join('');
        }

        // Renderizar lista de documentos
        function renderizarDocumentos() {
            const documentsList = document.getElementById('documentsList');
            const docs = documentosCache;

            if (docs.length === 0) {
                documentsList.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><p class="mb-0">Nenhum documento encontrado</p></td></tr>';
                return;
            }

            documentsList.innerHTML = docs.map(doc => {
                const pasta = pastasCache.find(p => p.id === doc.pastaId);
                const data = new Date(doc.dataCriacao).toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const pastaInfo = pasta 
                    ? `<span class="badge bg-light text-dark"><i class="bi bi-folder2"></i> ${pasta.nome}</span>` 
                    : '-';

                return `<tr draggable="true" ondragstart="iniciarArrastar(event, '${doc.id}')">
                    <td><i class="bi ${getIconeDocumento(doc.tipo)}"></i></td>
                    <td>${doc.nome}</td>
                    <td>${getTipoDocumento(doc.tipo)}</td>
                    <td>${formatarTamanho(doc.tamanho)}</td>
                    <td>${data}</td>
                    <td>${pastaInfo}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="${doc.url}" class="btn btn-link" target="_blank" title="Visualizar">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-link text-danger" onclick="excluirDocumento('${doc.id}')" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // Funções auxiliares
        function getIconeDocumento(tipo) {
            if (tipo.includes('pdf')) return 'bi-file-pdf text-danger';
            if (tipo.includes('word') || tipo.includes('docx')) return 'bi-file-word text-primary';
            if (tipo.includes('excel') || tipo.includes('xlsx')) return 'bi-file-excel text-success';
            if (tipo.includes('image')) return 'bi-file-image text-info';
            return 'bi-file-earmark text-secondary';
        }

        function getTipoDocumento(tipo) {
            if (tipo.includes('pdf')) return 'PDF';
            if (tipo.includes('word') || tipo.includes('docx')) return 'Word';
            if (tipo.includes('excel') || tipo.includes('xlsx')) return 'Excel';
            if (tipo.includes('image')) return 'Imagem';
            return 'Documento';
        }

        // Ordenação
        let ordenacaoAtual = { campo: 'dataCriacao', ordem: 'desc' };

        window.ordenarPor = function(campo) {
            if (ordenacaoAtual.campo === campo) {
                ordenacaoAtual.ordem = ordenacaoAtual.ordem === 'asc' ? 'desc' : 'asc';
            } else {
                ordenacaoAtual = { campo, ordem: 'asc' };
            }

            documentosCache.sort((a, b) => {
                let valorA = a[campo];
                let valorB = b[campo];

                if (campo === 'data') {
                    valorA = new Date(a.dataCriacao).getTime();
                    valorB = new Date(b.dataCriacao).getTime();
                }

                if (valorA < valorB) return ordenacaoAtual.ordem === 'asc' ? -1 : 1;
                if (valorA > valorB) return ordenacaoAtual.ordem === 'asc' ? 1 : -1;
                return 0;
            });

            renderizarDocumentos();
        }

        function formatarTamanho(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Byte';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
            return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
        }

        // Configurar drag and drop entre pastas
        function configurarDragAndDrop() {
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('documento-card')) {
                    e.dataTransfer.setData('text/plain', e.target.getAttribute('data-doc-id'));
                }
            });
        }

        // Funções para arrastar e soltar
        window.iniciarArrastar = function(event, docId) {
            event.dataTransfer.setData('text/plain', docId);
        }

        window.permitirSoltar = function(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        window.sairArrastar = function(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        window.soltarDocumento = async function(event, pastaId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const docId = event.dataTransfer.getData('text/plain');
            if (!docId) return;

            try {
                toggleLoading(true);

                // Atualizar documento no Firestore
                await updateDoc(doc(db, 'documentos', docId), {
                    pastaId: pastaId
                });

                // Atualizar cache e interface
                const documento = documentosCache.find(d => d.id === docId);
                if (documento) {
                    documento.pastaId = pastaId;
                    renderizarDocumentos();
                }

            } catch (error) {
                console.error('Erro ao mover documento:', error);
                alert('Erro ao mover documento. Por favor, tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Função para excluir pasta
        window.excluirPasta = async function(pastaId) {
            if (!confirm('Tem certeza que deseja excluir esta pasta e todos os documentos dentro dela?')) return;

            try {
                toggleLoading(true);

                // Excluir a pasta do Firestore
                await deleteDoc(doc(db, 'pastas', pastaId));

                // Excluir todos os documentos da pasta
                const docsNaPasta = documentosCache.filter(d => d.pastaId === pastaId);
                for (const doc of docsNaPasta) {
                    await deleteDoc(doc(db, 'documentos', doc.id));
                }

                // Atualizar cache e interface
                pastasCache = pastasCache.filter(p => p.id !== pastaId);
                documentosCache = documentosCache.filter(d => d.pastaId !== pastaId);
                renderizarPastas();
                renderizarDocumentos();

            } catch (error) {
                console.error('Erro ao excluir pasta:', error);
                alert('Erro ao excluir pasta. Por favor, tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Função para excluir documento
        window.excluirDocumento = async function(docId) {
            if (!confirm('Tem certeza que deseja excluir este documento?')) return;

            try {
                toggleLoading(true);

                // Excluir do Firestore
                await deleteDoc(doc(db, 'documentos', docId));

                // Atualizar cache e interface
                documentosCache = documentosCache.filter(d => d.id !== docId);
                renderizarDocumentos();

            } catch (error) {
                console.error('Erro ao excluir documento:', error);
                alert('Erro ao excluir documento. Por favor, tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Função para abrir pasta
        function abrirPasta(pastaId) {
            const pasta = pastasCache.find(p => p.id === pastaId);
            if (!pasta) return;

            const docs = documentosCache.filter(doc => doc.pastaId === pastaId);
            const documentsList = document.getElementById('documentsList');

            if (docs.length === 0) {
                documentsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <h4 class="alert-heading mb-2">${pasta.nome}</h4>
                            <p class="mb-0">Esta pasta está vazia</p>
                        </div>
                    </div>
                `;
                return;
            }

            documentsList.innerHTML = `
                <div class="col-12 mb-4">
                    <div class="alert alert-info">
                        <h4 class="alert-heading mb-2">${pasta.nome}</h4>
                        <p class="mb-0">${docs.length} documento(s)</p>
                    </div>
                </div>
            ` + docs.map(doc => `
                <div class="col-md-4 col-lg-3 mb-4">
                    <div class="card documento-card" draggable="true" ondragstart="iniciarArrastar(event, '${doc.id}')">
                        <div class="card-body">
                            <div class="documento-icon">
                                <i class="bi ${getIconeDocumento(doc.tipo)}"></i>
                            </div>
                            <h5 class="card-title">${doc.nome}</h5>
                            <p class="card-text small">${formatarTamanho(doc.tamanho)}</p>
                            <div class="card-actions">
                                <a href="${doc.url}" class="btn btn-link" target="_blank">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button class="btn btn-link text-danger" onclick="excluirDocumento('${doc.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function processarUpload(file) {
            try {
                toggleLoading(true);

                // Gerar nome único para o arquivo
                const timestamp = new Date().getTime();
                const nomeArquivo = `${timestamp}_${file.name}`;
                const storageRef = ref(storage, `documents/${currentUser.uid}/${nomeArquivo}`);

                // Fazer upload para o Storage
                const snapshot = await uploadBytesResumable(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                // Extrair tags sugeridas baseadas no nome e tipo do arquivo
                const tagsAutomaticas = gerarTagsAutomaticas(file);

                // Salvar metadados no Firestore
                const docRef = await addDoc(collection(db, 'documentos'), {
                    nome: file.name,
                    nomeArquivo: nomeArquivo,
                    tipo: file.type,
                    tamanho: file.size,
                    url: downloadURL,
                    userId: currentUser.uid,
                    dataCriacao: new Date(),
                    dataModificacao: new Date(),
                    tags: tagsAutomaticas,
                    permissoes: {
                        visualizar: true,
                        editar: true,
                        baixar: true
                    },
                    versoes: [{
                        data: new Date(),
                        autor: currentUser.email,
                        tamanho: file.size
                    }]
                });

                exibirNotificacao('Sucesso', 'Documento enviado com sucesso!');
                await carregarDocumentos(); // Recarregar lista

            } catch (error) {
                console.error('Erro no upload:', error);
                exibirNotificacao('Erro', 'Erro ao enviar documento. Tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Gerar tags automáticas baseadas no arquivo
        function gerarTagsAutomaticas(file) {
            const tags = [];
            
            // Adicionar tag do tipo de arquivo
            const tipoBase = file.type.split('/')[0];
            const extensao = file.name.split('.').pop().toLowerCase();
            
            if (tipoBase === 'image') tags.push('imagem');
            if (extensao === 'pdf') tags.push('pdf');
            if (['doc', 'docx'].includes(extensao)) tags.push('documento');
            if (['xls', 'xlsx'].includes(extensao)) tags.push('planilha');
            
            // Adicionar tags baseadas no nome do arquivo
            const nomeArquivo = file.name.toLowerCase();
            if (nomeArquivo.includes('relatorio')) tags.push('relatorio');
            if (nomeArquivo.includes('contrato')) tags.push('contrato');
            if (nomeArquivo.includes('foto')) tags.push('foto');
            
            return tags;
        }

        // Função para exibir notificações
        function exibirNotificacao(titulo, mensagem) {
            const toastHTML = `
                <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <strong class="me-auto">${titulo}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${mensagem}</div>
                </div>
            `;
            
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            toastContainer.innerHTML = toastHTML;
            document.body.appendChild(toastContainer);
            
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            // Remover após fechar
            toastContainer.addEventListener('hidden.bs.toast', () => {
                toastContainer.remove();
            });
        }

        // Variáveis para busca e filtros
        let todosDocumentos = [];
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const documentsList = document.getElementById('documentsList');
        const searchInput = document.getElementById('searchInput');

        // Função de busca inteligente
        async function realizarBusca(evento) {
            const termoBusca = evento.target.value.toLowerCase();
            const resultados = todosDocumentos.filter(doc => {
                // Busca no nome do arquivo
                if (doc.nome.toLowerCase().includes(termoBusca)) return true;
                
                // Busca nas tags
                if (doc.tags.some(tag => tag.toLowerCase().includes(termoBusca))) return true;
                
                // Busca com tolerância a erros de digitação (distância de Levenshtein)
                if (doc.tags.some(tag => calcularDistanciaLevenshtein(tag.toLowerCase(), termoBusca) <= 2)) return true;
                
                // Busca por sinônimos comuns
                const sinonimos = getSinonimos(termoBusca);
                if (doc.tags.some(tag => sinonimos.includes(tag.toLowerCase()))) return true;
                
                return false;
            });
            
            renderizarDocumentos(resultados);
        }

        // Função para calcular distância de Levenshtein (tolerância a erros de digitação)
        function calcularDistanciaLevenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];

            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        // Função para obter sinônimos comuns
        function getSinonimos(termo) {
            const dicionarioSinonimos = {
                'foto': ['imagem', 'figura', 'fotografia'],
                'documento': ['doc', 'arquivo', 'documentacao'],
                'planilha': ['excel', 'xls', 'xlsx', 'tabela'],
                'contrato': ['acordo', 'termo', 'documentacao'],
                'relatorio': ['report', 'registro', 'relato']
            };

            return dicionarioSinonimos[termo] || [];
        }

        // Função para aplicar filtros
        function aplicarFiltros() {
            const tiposSelecionados = Array.from(document.querySelectorAll('.form-check-input:checked'))
                .map(checkbox => checkbox.value);
            
            const filtroData = document.getElementById('filterDate').value;
            const dataInicio = document.getElementById('dateStart').value;
            const dataFim = document.getElementById('dateEnd').value;
            
            const tagsInput = document.getElementById('filterTags');
            const tagsSelecionadas = tagsInput.value ? JSON.parse(tagsInput.value).map(t => t.value) : [];

            const resultados = todosDocumentos.filter(doc => {
                // Filtro por tipo
                if (tiposSelecionados.length > 0) {
                    const extensao = doc.nome.split('.').pop().toLowerCase();
                    const tipoCorresponde = tiposSelecionados.some(tipo => {
                        if (tipo === 'pdf') return extensao === 'pdf';
                        if (tipo === 'docx') return ['doc', 'docx'].includes(extensao);
                        if (tipo === 'xlsx') return ['xls', 'xlsx'].includes(extensao);
                        if (tipo === 'image') return ['jpg', 'jpeg', 'png', 'gif'].includes(extensao);
                        return false;
                    });
                    if (!tipoCorresponde) return false;
                }

                // Filtro por data
                if (filtroData !== 'all') {
                    const dataDoc = doc.dataModificacao.toDate();
                    const hoje = new Date();
                    
                    if (filtroData === 'today') {
                        if (dataDoc.toDateString() !== hoje.toDateString()) return false;
                    } else if (filtroData === 'week') {
                        const umaSemanaAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (dataDoc < umaSemanaAtras) return false;
                    } else if (filtroData === 'month') {
                        const umMesAtras = new Date(hoje.getFullYear(), hoje.getMonth() - 1, hoje.getDate());
                        if (dataDoc < umMesAtras) return false;
                    } else if (filtroData === 'custom' && dataInicio && dataFim) {
                        const inicio = new Date(dataInicio);
                        const fim = new Date(dataFim);
                        if (dataDoc < inicio || dataDoc > fim) return false;
                    }
                }

                // Filtro por tags
                if (tagsSelecionadas.length > 0) {
                    if (!tagsSelecionadas.some(tag => doc.tags.includes(tag))) return false;
                }

                return true;
            });

            renderizarDocumentos(resultados);
        }

        // Event listeners para upload de arquivos
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.background = 'var(--bg-light)';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.background = 'var(--bg-white)';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.background = 'var(--bg-white)';
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                processarUpload(file);
            });
        }

        // Função para carregar e exibir documentos
        async function carregarDocumentos() {
            try {
                toggleLoading(true);
                const q = query(collection(db, 'documentos'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                
                todosDocumentos = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderizarDocumentos(todosDocumentos);
            } catch (error) {
                console.error('Erro ao carregar documentos:', error);
                exibirNotificacao('Erro', 'Erro ao carregar documentos. Tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Função para renderizar documentos na tela
        function renderizarDocumentos(documentos) {
            documentsList.innerHTML = '';
            
            if (documentos.length === 0) {
                documentsList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-folder2-open document-icon mb-3"></i>
                        <h4>Nenhum documento encontrado</h4>
                        <p class="text-muted">Faça upload de documentos ou ajuste seus filtros de busca.</p>
                    </div>
                `;
                return;
            }

            documentos.forEach(doc => {
                const extensao = doc.nome.split('.').pop().toLowerCase();
                let icone = 'bi-file-earmark-text';
                
                if (['jpg', 'jpeg', 'png', 'gif'].includes(extensao)) icone = 'bi-file-earmark-image';
                if (['pdf'].includes(extensao)) icone = 'bi-file-earmark-pdf';
                if (['doc', 'docx'].includes(extensao)) icone = 'bi-file-earmark-word';
                if (['xls', 'xlsx'].includes(extensao)) icone = 'bi-file-earmark-spreadsheet';

                const card = `
                    <div class="col-md-6 col-lg-4 mb-4" draggable="true" data-doc-id="${doc.id}">
                        <div class="document-card p-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <button class="btn btn-link p-0 favorite-btn" onclick="toggleFavorito('${doc.id}')">
                                    <i class="bi ${doc.favorito ? 'bi-star-fill text-warning' : 'bi-star'}"></i>
                                </button>
                                <div>
                                    <i class="bi ${icone} document-icon"></i>
                                    <h5 class="mt-2 mb-1">${doc.nome}</h5>
                                    <p class="text-muted small mb-2">
                                        Modificado em: ${formatarData(doc.dataModificacao.toDate())}
                                    </p>
                                    <div class="tags-container">
                                        ${doc.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirPreview('${doc.id}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                documentsList.innerHTML += card;
            });
        }

        // Função para formatar data
        function formatarData(data) {
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(data);
        }

        // Função para abrir preview do documento
        async function abrirPreview(docId) {
            try {
                toggleLoading(true);
                const docRef = doc(db, 'documentos', docId);
                const docSnap = await getDocs(docRef);
                const documento = { id: docSnap.id, ...docSnap.data() };

                // Preencher informações do documento no modal
                document.getElementById('previewFileName').textContent = documento.nome;
                document.getElementById('previewFileType').textContent = documento.tipo;
                document.getElementById('previewFileSize').textContent = formatarTamanho(documento.tamanho);
                document.getElementById('previewLastModified').textContent = formatarData(documento.dataModificacao.toDate());

                // Preencher tags
                const tagsContainer = document.getElementById('previewTags');
                tagsContainer.innerHTML = documento.tags
                    .map(tag => `<span class="tag">${tag}</span>`)
                    .join('');

                // Preencher histórico de versões
                const versionsContainer = document.getElementById('versionHistory');
                versionsContainer.innerHTML = documento.versoes
                    .map(versao => `
                        <div class="version-item">
                            <p class="mb-1"><strong>${formatarData(versao.data.toDate())}</strong></p>
                            <p class="mb-0 small text-muted">Por: ${versao.autor}</p>
                            <p class="mb-0 small text-muted">Tamanho: ${formatarTamanho(versao.tamanho)}</p>
                        </div>
                    `)
                    .join('');

                // Configurar permissões
                document.getElementById('permissionView').checked = documento.permissoes.visualizar;
                document.getElementById('permissionEdit').checked = documento.permissoes.editar;
                document.getElementById('permissionDownload').checked = documento.permissoes.baixar;

                // Carregar preview do documento
                const previewContainer = document.getElementById('documentPreview');
                if (documento.tipo.startsWith('image/')) {
                    previewContainer.innerHTML = `<img src="${documento.url}" class="img-fluid" alt="${documento.nome}">`;
                } else if (documento.tipo === 'application/pdf') {
                    // Usar PDF.js para renderizar PDF
                    const loadingTask = pdfjsLib.getDocument(documento.url);
                    const pdf = await loadingTask.promise;
                    const page = await pdf.getPage(1);
                    const viewport = page.getViewport({ scale: 1.5 });

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    previewContainer.innerHTML = '';
                    previewContainer.appendChild(canvas);
                } else {
                    previewContainer.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-file-earmark document-icon mb-3"></i>
                            <h5>Preview não disponível</h5>
                            <p>Faça o download para visualizar este tipo de arquivo.</p>
                        </div>
                    `;
                }

                // Abrir modal
                const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
                previewModal.show();

            } catch (error) {
                console.error('Erro ao abrir preview:', error);
                exibirNotificacao('Erro', 'Erro ao abrir preview do documento.');
            } finally {
                toggleLoading(false);
            }
        }

        // Função para formatar tamanho do arquivo
        function formatarTamanho(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            let size = bytes;
            let unitIndex = 0;

            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }

            return `${size.toFixed(1)} ${units[unitIndex]}`;
        }

        // Função para excluir documento
        async function excluirDocumento(docId) {
            if (!confirm('Tem certeza que deseja excluir este documento?')) return;

            try {
                toggleLoading(true);
                const docRef = doc(db, 'documentos', docId);
                const docSnap = await getDocs(docRef);
                const documento = docSnap.data();

                // Excluir arquivo do Storage
                const storageRef = ref(storage, `documents/${currentUser.uid}/${documento.nomeArquivo}`);
                await deleteObject(storageRef);

                // Excluir documento do Firestore
                await deleteDoc(docRef);

                exibirNotificacao('Sucesso', 'Documento excluído com sucesso!');
                await carregarDocumentos();

            } catch (error) {
                console.error('Erro ao excluir documento:', error);
                exibirNotificacao('Erro', 'Erro ao excluir documento. Tente novamente.');
            } finally {
                toggleLoading(false);
            }
        }

        // Inicializar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        // Eventos do modal de preview
        document.getElementById('downloadDocument').addEventListener('click', async () => {
            const docId = document.getElementById('previewModal').getAttribute('data-doc-id');
            const docRef = doc(db, 'documentos', docId);
            const docSnap = await getDocs(docRef);
            const documento = docSnap.data();

            if (documento.permissoes.baixar) {
                window.open(documento.url, '_blank');
            } else {
                exibirNotificacao('Erro', 'Você não tem permissão para baixar este documento.');
            }
        });

        document.getElementById('printDocument').addEventListener('click', async () => {
            const docId = document.getElementById('previewModal').getAttribute('data-doc-id');
            const docRef = doc(db, 'documentos', docId);
            const docSnap = await getDocs(docRef);
            const documento = docSnap.data();

            if (documento.permissoes.visualizar) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Imprimir - ${documento.nome}</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                img { max-width: 100%; height: auto; }
                            </style>
                            <script type="module" src="../js/auth-guard.js"></script>
<script src="../js/permissoes.js" type="module"></script>
<script src="../js/preferencias.js" type="module"></script>
<script src="../js/preferencia-aplicacao.js" type="module"></script>
<body>
<h1>${documento.nome}</h1>
                            ${document.getElementById('documentPreview').innerHTML}
                        
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const html = document.documentElement;
    const body = document.body;
    const fonte = localStorage.getItem('preferenciaFonte');
    const tema = localStorage.getItem('preferenciaTema');
    const leitura = localStorage.getItem('preferenciaLeitura');

    if (tema === 'escuro') html.classList.add('dark-mode');
    else html.classList.remove('dark-mode');

    if (leitura === 'ativado') html.classList.add('modo-leitura');
    else html.classList.remove('modo-leitura');

    if (fonte) {
      html.style.setProperty('--tamanho-fonte', fonte);
    }
  });
</script>
</body>

<div class="assistente" id="assistente-virtual">
<input id="chat-input" placeholder="Digite sua pergunta..." type="text"/>
<button id="enviar-chat">Enviar</button>
</div>
</body></html>
                `);
                printWindow.document.close();
                printWindow.print();
            } else {
                exibirNotificacao('Erro', 'Você não tem permissão para imprimir este documento.');
            }
        });

        document.getElementById('shareDocument').addEventListener('click', async () =&gt; {
            const docId = document.getElementById('previewModal').getAttribute('data-doc-id');
            const docRef = doc(db, 'documentos', docId);
            const docSnap = await getDocs(docRef);
            const documento = docSnap.data();

            // Criar link temporário de compartilhamento
            const linkCompartilhamento = `${window.location.origin}/visualizar.html?doc=${docId}`;
            
            // Copiar para clipboard
            navigator.clipboard.writeText(linkCompartilhamento)
                .then(() =&gt; {
                    exibirNotificacao('Sucesso', 'Link de compartilhamento copiado para a área de transferência!');
                })
                .catch(() =&gt; {
                    exibirNotificacao('Erro', 'Não foi possível copiar o link.');
                });
        });

        // Eventos de permissões
        ['View', 'Edit', 'Download'].forEach(tipo =&gt; {
            document.getElementById(`permission${tipo}`).addEventListener('change', async (e) =&gt; {
                const docId = document.getElementById('previewModal').getAttribute('data-doc-id');
                const docRef = doc(db, 'documentos', docId);
                
                try {
                    await updateDoc(docRef, {
                        [`permissoes.${tipo.toLowerCase()}`]: e.target.checked
                    });
                    
                    exibirNotificacao('Sucesso', 'Permissões atualizadas com sucesso!');
                } catch (error) {
                    console.error('Erro ao atualizar permissões:', error);
                    exibirNotificacao('Erro', 'Erro ao atualizar permissões.');
                    e.target.checked = !e.target.checked; // Reverter checkbox
                }
            });
        });

        // Atalhos de teclado
        document.addEventListener('keydown', (e) =&gt; {
            // Ctrl/Cmd + F para focar na busca
            if ((e.ctrlKey || e.metaKey) &amp;&amp; e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }

            // Esc para fechar modal
            if (e.key === 'Escape') {
                const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
                if (modal) modal.hide();
            }
        });

        // Observador de tema do sistema
        window.matchMedia('(prefers-color-scheme: dark)').addListener((e) =&gt; {
            if (!localStorage.getItem('darkMode')) { // Só mudar se usuário não definiu preferência
                document.body.classList.toggle('dark-mode', e.matches);
                document.getElementById('darkModeToggle').checked = e.matches;
            }
        });

        // Funções para Favoritos
        async function toggleFavorito(docId) {
            try {
                const docRef = doc(db, 'documentos', docId);
                const docSnap = await getDocs(docRef);
                const documento = docSnap.data();
                
                await updateDoc(docRef, {
                    favorito: !documento.favorito
                });
                
                await carregarDocumentos();
                exibirNotificacao('Sucesso', documento.favorito ? 'Removido dos favoritos!' : 'Adicionado aos favoritos!');
            } catch (error) {
                console.error('Erro ao atualizar favorito:', error);
                exibirNotificacao('Erro', 'Erro ao atualizar favoritos.');
            }
        }

        // Funções para Pastas
        async function criarPasta() {
            const nomePasta = prompt('Digite o nome da nova pasta:');
            if (!nomePasta) return;

            try {
                await addDoc(collection(db, 'pastas'), {
                    nome: nomePasta,
                    userId: currentUser.uid,
                    dataCriacao: new Date()
                });

                carregarPastas();
                exibirNotificacao('Sucesso', 'Pasta criada com sucesso!');
            } catch (error) {
                console.error('Erro ao criar pasta:', error);
                exibirNotificacao('Erro', 'Erro ao criar pasta.');
            }
        }

        async function carregarPastas() {
            try {
                const q = query(collection(db, 'pastas'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                const pastasList = document.getElementById('pastasList');
                
                pastasList.innerHTML = '';
                querySnapshot.forEach(doc =&gt; {
                    const pasta = doc.data();
                    pastasList.innerHTML += `
                        <div class="col-md-3 mb-3">
<div class="document-card p-3" data-pasta-id="${doc.id}" ondragover="event.preventDefault()" ondrop="moverParaPasta(event, '${doc.id}')">
<div class="d-flex align-items-center">
<i class="bi bi-folder2 document-icon me-2"></i>
<h6 class="mb-0">${pasta.nome}</h6>
</div>
</div>
</div>
                    `;
                });
            } catch (error) {
                console.error('Erro ao carregar pastas:', error);
            }
        }

        async function moverParaPasta(event, pastaId) {
            event.preventDefault();
            const docId = event.dataTransfer.getData('text/plain');
            
            try {
                const docRef = doc(db, 'documentos', docId);
                await updateDoc(docRef, { pastaId });
                
                exibirNotificacao('Sucesso', 'Documento movido com sucesso!');
                await carregarDocumentos();
            } catch (error) {
                console.error('Erro ao mover documento:', error);
                exibirNotificacao('Erro', 'Erro ao mover documento.');
            }
        }

        // Funções para Comentários
        async function adicionarComentario() {
            const texto = document.getElementById('novoComentario').value.trim();
            if (!texto) return;

            const docId = document.getElementById('previewModal').getAttribute('data-doc-id');
            try {
                const docRef = doc(db, 'documentos', docId);
                const comentario = {
                    texto,
                    autor: currentUser.email,
                    data: new Date(),
                    userId: currentUser.uid
                };

                await updateDoc(docRef, {
                    comentarios: arrayUnion(comentario)
                });

                document.getElementById('novoComentario').value = '';
                await carregarComentarios(docId);
                exibirNotificacao('Sucesso', 'Comentário adicionado!');
            } catch (error) {
                console.error('Erro ao adicionar comentário:', error);
                exibirNotificacao('Erro', 'Erro ao adicionar comentário.');
            }
        }

        async function carregarComentarios(docId) {
            try {
                const docRef = doc(db, 'documentos', docId);
                const docSnap = await getDocs(docRef);
                const documento = docSnap.data();
                const comentariosList = document.getElementById('comentariosList');

                comentariosList.innerHTML = '';
                if (documento.comentarios &amp;&amp; documento.comentarios.length &gt; 0) {
                    documento.comentarios.forEach(comentario =&gt; {
                        comentariosList.innerHTML += `
                            <div class="comentario-item mb-3">
<div class="d-flex justify-content-between">
<strong>${comentario.autor}</strong>
<small class="text-muted">${formatarData(comentario.data.toDate())}</small>
</div>
<p class="mb-0">${comentario.texto}</p>
</div>
                        `;
                    });
                } else {
                    comentariosList.innerHTML = '<p class="text-muted">Nenhum comentário ainda.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar comentários:', error);
            }
        }

        // Configurar drag and drop para documentos
        document.addEventListener('dragstart', (e) =&gt; {
            if (e.target.hasAttribute('data-doc-id')) {
                e.dataTransfer.setData('text/plain', e.target.getAttribute('data-doc-id'));
            }
        });

        // Inicializar tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Carregar pastas ao iniciar
        carregarPastas();
    
<!-- Settings Manager -->
<script src="../js/settings-manager.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Configuração da barra de busca
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const chips = document.querySelectorAll('.chip');
        const quickFilterDate = document.getElementById('quickFilterDate');

    // Limpar busca
    clearSearch?.addEventListener('click', () => {
        searchInput.value = '';
        clearSearch.classList.add('d-none');
        realizarBusca({ target: { value: '' } });
    });

    // Mostrar/ocultar botão de limpar
    searchInput?.addEventListener('input', (e) => {
        if (e.target.value) {
            clearSearch.classList.remove('d-none');
        } else {
            clearSearch.classList.add('d-none');
        }
    });

    // Filtros rápidos por tipo
    chips?.forEach(chip => {
        chip.addEventListener('click', () => {
            chip.classList.toggle('active');
            aplicarFiltrosRapidos();
        });
    });

    // Filtro rápido por data
    quickFilterDate?.addEventListener('change', aplicarFiltrosRapidos);

    function aplicarFiltrosRapidos() {
        const tiposSelecionados = Array.from(document.querySelectorAll('.chip.active'))
            .map(chip => chip.getAttribute('data-type'));
        const filtroData = quickFilterDate.value;

        const documentosFiltrados = todosDocumentos.filter(doc => {
            // Filtro por tipo
            if (tiposSelecionados.length > 0 && !tiposSelecionados.includes(doc.tipo)) {
                return false;
            }

            // Filtro por data
            if (filtroData !== 'all') {
                const dataDoc = new Date(doc.data);
                const hoje = new Date();
                
                switch (filtroData) {
                    case 'today':
                        return isSameDay(dataDoc, hoje);
                    case 'week':
                        const umaSemanaAtras = new Date(hoje.setDate(hoje.getDate() - 7));
                        return dataDoc >= umaSemanaAtras;
                    case 'month':
                        const umMesAtras = new Date(hoje.setMonth(hoje.getMonth() - 1));
                        return dataDoc >= umMesAtras;
                }
            }

            return true;
        });

        renderizarDocumentos(documentosFiltrados);
    }

    function isSameDay(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
            d1.getMonth() === d2.getMonth() &&
            d1.getDate() === d2.getDate();
    }
  const lista = document.getElementById("documentosLista");
  const input = document.getElementById("uploadDocumento");
  const btnSalvar = document.getElementById("btnSalvarDocumento");

  let documentos = carregarLocal("simulacaoDocumentos") || [];

  function renderizarDocumentos() {
    lista.innerHTML = "";
    documentos.forEach((doc, index) => {
      const li = document.createElement("li");
      li.innerHTML = \`
        <div>
          📄 \${doc.nome} - <em>\${doc.data}</em>
        </div>
      \`;
      lista.appendChild(li);
    });
  }

  renderizarDocumentos();

  btnSalvar?.addEventListener("click", () => {
    if (!input.files.length) return alert("Selecione um arquivo!");
    const nome = input.files[0].name;
    const data = new Date().toISOString().split("T")[0];
    documentos.push({ nome, data });
    salvarLocal("simulacaoDocumentos", documentos);
    renderizarDocumentos();
    input.value = "";
  });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const html = document.documentElement;
    const body = document.body;
    const fonte = localStorage.getItem('preferenciaFonte');
    const tema = localStorage.getItem('preferenciaTema');
    const leitura = localStorage.getItem('preferenciaLeitura');

    if (tema === 'escuro') html.classList.add('dark-mode');
    else html.classList.remove('dark-mode');

    if (leitura === 'ativado') html.classList.add('modo-leitura');
    else html.classList.remove('modo-leitura');

    if (fonte) {
      html.style.setProperty('--tamanho-fonte', fonte);
    }
  });
</script>
